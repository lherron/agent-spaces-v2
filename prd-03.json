{
  "project": "Agent Spaces v2",
  "branchName": "ralph/phase-3-store",
  "description": "Phase 3 - Store & Integrity: Content-addressed storage, git-tree integrity hashing, snapshot extraction, environment hashes",
  "userStories": [
    {
      "id": "US-001",
      "title": "Implement ASP_HOME Path Resolution",
      "description": "As a developer, I need consistent path resolution for the ASP home directory.",
      "acceptanceCriteria": [
        "getAspHome(): string function in packages/store/src/paths.ts",
        "Uses ASP_HOME env var if set",
        "Falls back to ~/.asp on macOS/Linux",
        "Falls back to %USERPROFILE%\\.asp on Windows",
        "Creates directory if it doesn't exist",
        "Unit tests for env var override",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Implement Store Path Helpers",
      "description": "As a developer, I need path builders for store subdirectories.",
      "acceptanceCriteria": [
        "getStorePath(): string returns $ASP_HOME/store",
        "getSpaceStorePath(integrity: string): string returns $ASP_HOME/store/spaces/sha256/<integrity>",
        "getCachePath(): string returns $ASP_HOME/cache",
        "getMaterializedCachePath(cacheKey: string, pluginName: string): string returns correct path",
        "getRepoPath(): string returns $ASP_HOME/repo",
        "getGlobalLockPath(): string returns $ASP_HOME/global-lock.json",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Implement Git Tree Listing",
      "description": "As a developer, I need to list git tree entries for fast integrity hashing.",
      "acceptanceCriteria": [
        "listTreeEntries(spacePath: string, commit: string, repoPath: string): Promise<TreeEntry[]> function",
        "Uses git ls-tree -r for recursive listing",
        "TreeEntry includes path, mode, blobOid",
        "Paths are relative to space directory",
        "Sorted alphabetically by path",
        "Unit tests with mock git",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Implement Git-Based Integrity Hash",
      "description": "As a developer, I need fast integrity hashing using git tree metadata (no file I/O).",
      "acceptanceCriteria": [
        "computeGitIntegrity(entries: TreeEntry[]): string function",
        "Hash format: sha256-<hex> per spec",
        "Hashes: path + '\\0' + mode + '\\0' + blobOid + '\\n' for each entry",
        "Entries must be sorted alphabetically before hashing",
        "Deterministic: same entries produce same hash",
        "Unit tests with known test vectors",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Implement File-Walk Integrity Hash",
      "description": "As a developer, I need file-walk integrity hashing for dev mode (local paths not in git).",
      "acceptanceCriteria": [
        "computeFileIntegrity(dirPath: string): Promise<string> function",
        "Walks directory recursively",
        "Hashes: relativePath + '\\0' + fileContent for each file",
        "Files sorted alphabetically by path",
        "Ignores .git, node_modules, .DS_Store",
        "Deterministic: same files produce same hash",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Implement Unified Integrity Function",
      "description": "As a developer, I need a single function that computes integrity based on source type.",
      "acceptanceCriteria": [
        "computeIntegrity(source: IntegritySource): Promise<string> function",
        "IntegritySource is { type: 'git', ... } or { type: 'filesystem', path: string }",
        "Dispatches to git-based or file-walk based on type",
        "Unit tests for both types",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Implement Space Snapshot Extraction",
      "description": "As a developer, I need to extract a space at a specific commit into the store.",
      "acceptanceCriteria": [
        "extractSnapshot(spaceId: string, commit: string, repoPath: string): Promise<SnapshotResult> function",
        "Computes integrity hash first",
        "If already in store (by integrity), returns existing path (cache hit)",
        "If not in store, extracts using git archive",
        "Stores at $ASP_HOME/store/spaces/sha256/<integrity>/",
        "SnapshotResult includes integrity, path, cached: boolean",
        "Integration test with real git repo",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Implement Atomic Snapshot Storage",
      "description": "As a developer, I need snapshot storage to be atomic to prevent corruption.",
      "acceptanceCriteria": [
        "Extraction writes to temp directory first",
        "Renames to final path atomically",
        "Handles concurrent extractions (second process waits or uses existing)",
        "Cleans up temp directory on failure",
        "Integration test for concurrent access",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Implement Snapshot Lookup",
      "description": "As a developer, I need to look up existing snapshots by integrity.",
      "acceptanceCriteria": [
        "lookupSnapshot(integrity: string): SnapshotInfo | null function",
        "Returns { path, integrity } if exists",
        "Returns null if not in store",
        "Validates directory structure (has space.toml)",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement Environment Hash",
      "description": "As a developer, I need to compute an environment hash for cache invalidation.",
      "acceptanceCriteria": [
        "computeEnvHash(loadOrder: LoadOrderEntry[]): string function",
        "LoadOrderEntry includes spaceKey, integrity, pluginName",
        "Hashes ordered list of entries",
        "Different load orders produce different hashes",
        "Deterministic",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement Store Garbage Collection",
      "description": "As a developer, I need to remove unreferenced store entries.",
      "acceptanceCriteria": [
        "collectGarbage(referencedIntegrities: Set<string>): Promise<GCResult> function",
        "Lists all entries in store",
        "Removes entries not in referenced set",
        "GCResult includes removed: string[], kept: number, freedBytes: number",
        "Does not remove entries currently being written (checks for .tmp)",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Implement Reference Collection",
      "description": "As a developer, I need to collect all referenced integrities from lock files.",
      "acceptanceCriteria": [
        "collectReferences(lockPaths: string[]): Promise<Set<string>> function",
        "Reads each lock file",
        "Extracts all integrity values",
        "Returns union of all referenced integrities",
        "Handles missing/invalid lock files gracefully",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Implement Store Statistics",
      "description": "As a developer, I need to query store statistics for asp list and asp doctor.",
      "acceptanceCriteria": [
        "getStoreStats(): Promise<StoreStats> function",
        "StoreStats includes entryCount, totalBytes, oldestEntry, newestEntry",
        "Efficient implementation (doesn't read file contents)",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    }
  ]
}
