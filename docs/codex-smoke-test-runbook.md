# Codex Integration Smoke Test Runbook

Manual smoke test for Codex harness integration with agent-spaces, using the real agent-spaces project setup.

## Prerequisites

### 1. Verify Codex CLI is installed

```bash
codex --version
```

**Expected:** Version string (e.g., `codex 0.87.x`). Minimum supported version: `0.1.0`.

### 2. Verify app-server subcommand exists

```bash
codex app-server --help
```

**Expected:** Help text for the app-server subcommand. If this fails, Codex may be outdated.

### 3. Verify Codex OAuth login

```bash
codex login status
```

**Expected:** `Logged in using ChatGPT` or similar OAuth status.

If not logged in, run:
```bash
codex login
```

**Important:** Codex uses OAuth authentication stored in `~/.codex/auth.json`. The `OPENAI_API_KEY` environment variable is **not used** for authentication. When using a custom `CODEX_HOME`, the `auth.json` file must be present (the adapter creates a symlink automatically).

### 4. Verify Control Plane is running

```bash
curl -s 'http://127.0.0.1:18420/admin/status' -H 'x-cp-token: dev' | jq .
```

**Expected:** Status response with `{ "status": "ok", ... }`

### 5. Set test variables

```bash
BASE="http://127.0.0.1:18420"
TOKEN="x-cp-token: dev"
ASP_ROOT="$HOME/praesidium/agent-spaces"
ASP_CLI="bun run $ASP_ROOT/packages/cli/bin/asp.js"
```

### 6. Navigate to agent-spaces project

```bash
cd "$ASP_ROOT"
```

---

## Part 1: Harness Detection and Target Setup

### Test 1: Verify Codex Harness is Registered

```bash
$ASP_CLI harnesses 2>&1
```

**Expected:** Output includes `codex (experimental)` in the list of available harnesses.

---

### Test 2: Add Codex Test Target

Add a codex target to `asp-targets.toml` that uses real spaces.

**Important:** Do NOT include `harness = "codex"` - the schema doesn't support it. Instead, use the `[codex]` subtable.

```bash
# Check current targets
cat asp-targets.toml

# Add codex-test target (if not already present)
cat >> asp-targets.toml << 'EOF'

[targets.codex-test]
description = "Codex smoke test target"
compose = ["space:smokey@dev", "space:defaults@stable"]

[targets.codex-test.codex]
model = "gpt-5.2-codex"
approval_policy = "on-request"
sandbox_mode = "workspace-write"
EOF

echo "Target added. Current targets:"
grep '^\[targets\.' asp-targets.toml
```

**Expected:** `codex-test` target added with smokey and defaults spaces.

**Note:** The `smokey` space includes skills for smoke testing, making it a good candidate.

---

### Test 3: Run asp install for Codex Target

**Important:** Use `--targets` (plural) and `--harness codex`:

```bash
$ASP_CLI install --targets codex-test --harness codex 2>&1
```

**Expected:**
- No errors
- Output indicates successful materialization
- Creates `codex.home/` directory in `asp_modules/codex-test/codex/`
- Shows codex run command (not claude)

---

## Part 2: Materialization Verification

### Test 4: Verify Codex Home Template Structure

```bash
ls -la asp_modules/codex-test/codex/codex.home/
```

**Expected structure:**
```
codex.home/
  AGENTS.md
  auth.json -> ~/.codex/auth.json (symlink)
  config.toml
  manifest.json
  skills/
  prompts/
```

**Important:** `auth.json` should be a symlink to `~/.codex/auth.json` for OAuth to work.

---

### Test 5: Verify Skills Materialization

The `smokey` space includes the `smoke-testing` skill. Verify it's copied:

```bash
ls -la asp_modules/codex-test/codex/codex.home/skills/
```

**Expected:** Contains `smoke-testing/` directory (from smokey space).

```bash
head -20 asp_modules/codex-test/codex/codex.home/skills/smoke-testing/SKILL.md
```

**Expected:** Content from the smokey smoke-testing skill.

---

### Test 6: Verify Playbooks Are Included

The smoke-testing skill includes playbook files:

```bash
ls -la asp_modules/codex-test/codex/codex.home/skills/smoke-testing/playbooks/
```

**Expected:** Playbook files like `quick-sanity.md`, `full-sweep.md`, `codex-integration.md`, etc.

---

### Test 7: Verify Commands â†’ Prompts Mapping

Check if any commands from the spaces were converted to Codex prompts:

```bash
ls -la asp_modules/codex-test/codex/codex.home/prompts/ 2>/dev/null || echo "Empty prompts directory (expected if no commands in composed spaces)"
```

**Expected:** Either prompts directory with `.md` files, or empty directory if source spaces don't have commands.

---

### Test 8: Verify AGENTS.md Generation

```bash
cat asp_modules/codex-test/codex/codex.home/AGENTS.md
```

**Expected:**
- Contains a generated header (`<!-- Generated by agent-spaces. -->`)
- If spaces have instructions, contains content wrapped in markers:
  ```
  <!-- BEGIN space: smokey@<version> -->
  ...
  <!-- END space: smokey@<version> -->
  ```

---

### Test 9: Verify config.toml Generation

```bash
cat asp_modules/codex-test/codex/codex.home/config.toml
```

**Expected:**
- `sandbox_mode = "workspace-write"`
- `approval_policy = "on-request"`
- `project_doc_fallback_filenames = ["AGENTS.md", "AGENT.md"]`
- `model = "gpt-5.2-codex"`
- MCP server definitions if the spaces include MCP configurations

---

### Test 10: Verify auth.json Symlink

```bash
ls -la asp_modules/codex-test/codex/codex.home/auth.json
```

**Expected:** Symlink pointing to `~/.codex/auth.json`

If not present, OAuth won't work when CODEX_HOME is set to the materialized home.

---

## Part 3: CLI Execution Tests

### Test 11: Dry Run - Verify Command Generation

```bash
$ASP_CLI run codex-test --harness codex --dry-run
```

**Expected command format:**
```
CODEX_HOME=.../asp_modules/codex-test/codex/codex.home codex --model gpt-5.2-codex --ask-for-approval on-request --sandbox workspace-write
```

**Important flags:**
- `--ask-for-approval` (NOT `--approval-policy`)
- `--sandbox` (NOT `--sandbox-mode`)

---

### Test 12: Run Chat Session with Prompt

```bash
$ASP_CLI run codex-test "What is 2+2? Answer with just the number." --harness codex
```

**Expected:**
- Codex starts with CODEX_HOME set to materialized home
- Shows model: gpt-5.2-codex
- Returns answer: `4`
- Shows token usage

**Note:** For exec mode, the adapter uses `-c 'approval_policy="on-request"'` config override instead of the `--ask-for-approval` flag.

---

### Test 13: Verify Skills Discovery

```bash
$ASP_CLI run codex-test "What skills do you have access to? Just list the skill names." --harness codex
```

**Expected:** Response includes `smoke-testing` skill from the composed spaces.

---

### Test 14: Test Session Resumption

After running Test 12 or 13, resume the session:

```bash
CODEX_HOME="$PWD/asp_modules/codex-test/codex/codex.home" codex exec resume --last "What was my previous question?"
```

**Expected:** Codex remembers the previous question and context, proving session state is maintained.

---

## Part 4: Programmatic Interface Test

### Test 15: Run Codex Interface Test Script

This script tests the agent-spaces client library with the codex harness:

```bash
bun scripts/codex-interface-test.ts --target codex-test --target-dir "$PWD" "What skills are available?"
```

**Expected:**
- `describe.skills` includes `smoke-testing`
- `runTurn` completes successfully
- `finalOutput` lists available skills
- Resume test passes (context maintained)

### Test 16: Run with Different Prompt

```bash
bun scripts/codex-interface-test.ts \
  --target codex-test \
  --target-dir "$PWD" \
  "What is 2+2?"
```

**Expected:** Same structure as Test 15, with answer "4".

---

## Part 5: App-Server Protocol Tests (Manual)

### Test 17: Start Codex App-Server Directly

In a **separate terminal**, start the app-server with the materialized home:

```bash
cd ~/praesidium/agent-spaces
CODEX_HOME="$PWD/asp_modules/codex-test/codex/codex.home" codex app-server
```

**Expected:** Server starts and waits for JSON-RPC input on stdin.

### Test 18: Initialize Handshake

Send initialize request by pasting into the app-server terminal:

```json
{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"clientInfo":{"name":"agent-spaces-test","version":"1.0.0"}}}
```

**Expected:** Server responds with capabilities JSON containing `userAgent`.

---

## Part 6: Control Plane Integration Tests (Optional)

These tests require a control-plane project configured with `sessionBackend.kind: "codex"`.

### Test 19: Check for Codex-Enabled Project

```bash
curl -s "$BASE/admin/projects" -H "$TOKEN" | jq -r '.[] | "\(.projectId): \(.sessionBackend.kind // "none")"'
```

**Expected:** If no project shows `codex`, Part 6 tests should be skipped.

**Note:** Creating a codex-enabled project requires control-plane configuration changes.

---

## Success Criteria

| Test | Criteria |
|------|----------|
| Codex detection | `asp harnesses` shows `codex (experimental)` |
| Target creation | `codex-test` target added (no `harness` property) |
| Space resolution | Resolves `space:smokey@dev` and `space:defaults@stable` |
| Materialization | `asp install --targets codex-test --harness codex` completes |
| auth.json | Symlink created to `~/.codex/auth.json` |
| Skills | `smoke-testing` skill copied to `codex/codex.home/skills/` |
| Playbooks | Skill subdirectories (playbooks/) preserved |
| AGENTS.md | Instructions merged with generated header |
| config.toml | Contains model, approval_policy, sandbox_mode, project_doc_fallback |
| Dry run | Shows correct flags (`--ask-for-approval`, `--sandbox`) |
| Chat session | `asp run` with prompt returns correct answer |
| Skills query | Model sees `smoke-testing` skill |
| Session resume | Context maintained via codex resume |
| Interface test | `codex-interface-test.ts` passes |

---

## Cleanup

```bash
# Remove test target from asp-targets.toml (optional)
# Edit asp-targets.toml and remove [targets.codex-test] section

# Clean materialized output
rm -rf asp_modules/codex-test

# Sessions persist in codex.home until manually cleaned
```

---

## Troubleshooting

### "401 Unauthorized" / "Missing bearer or basic authentication"

**Cause:** OAuth credentials (`auth.json`) not found in CODEX_HOME.

**Fix:**
```bash
# Verify OAuth login
codex login status

# If using custom CODEX_HOME, ensure auth.json is symlinked
ls -la $CODEX_HOME/auth.json

# If missing, create symlink
ln -sf ~/.codex/auth.json $CODEX_HOME/auth.json
```

**Note:** The adapter should create this symlink automatically. If missing, re-run `asp install --targets <target> --harness codex`.

### "codex: command not found"

Install Codex CLI:
```bash
# Follow installation instructions from OpenAI Codex documentation
# https://developers.openai.com/codex/cli/
```

### "app-server: unknown subcommand"

The `app-server` subcommand is experimental. Ensure you have a recent version of Codex:
```bash
codex --version
# Update if < 0.87.0
```

### "unknown option '--approval-policy'"

The codex adapter was updated to use correct flags. Ensure you have the latest agent-spaces code:
- Interactive mode: `--ask-for-approval`
- Exec mode: `-c 'approval_policy="value"'`
- Both modes: `--sandbox` (not `--sandbox-mode`)

### "unknown property 'harness'" in asp-targets.toml

The `harness` property is not supported at target level. Remove it:
```toml
# WRONG:
[targets.codex-test]
harness = "codex"  # Remove this line

# CORRECT:
[targets.codex-test]
compose = ["space:smokey@dev"]

[targets.codex-test.codex]
model = "gpt-5.2-codex"
```

### "Space not found: smokey@dev"

Ensure the smokey space is registered:
```bash
$ASP_CLI spaces list 2>&1 | grep smokey
```

### Skills/prompts not appearing in codex.home

Verify materialization completed with `--harness codex`:
```bash
$ASP_CLI install --targets codex-test --harness codex
ls -laR asp_modules/codex-test/codex/codex.home/
```

### OAuth not working with custom CODEX_HOME

Verify auth.json symlink exists:
```bash
ls -la asp_modules/codex-test/codex/codex.home/auth.json
```

If missing, the adapter should create it automatically. Re-run install or manually create:
```bash
ln -sf ~/.codex/auth.json asp_modules/codex-test/codex/codex.home/auth.json
```

---

## Notes

- **OAuth Authentication:** Codex CLI uses OAuth by default (`codex login`). Credentials are stored in `~/.codex/auth.json`. The `OPENAI_API_KEY` env var is NOT used for authentication.
- **Custom CODEX_HOME:** When using a custom CODEX_HOME (as agent-spaces does), the `auth.json` must be present. The adapter automatically symlinks it from `~/.codex/auth.json`.
- **Experimental Status:** The Codex harness uses the experimental `codex app-server` subcommand. Behavior may change.
- **CLI Flag Differences:** `codex` and `codex exec` have different flag sets. The adapter handles this automatically.
- **Model Availability:** Ensure your OpenAI account has access to Codex models (e.g., `gpt-5.2-codex`).
- **Real Spaces:** This runbook uses `space:smokey@dev` which provides the smoke-testing skill with playbooks.
