{
  "project": "Agent Spaces v2",
  "branchName": "ralph/phase-1-foundation",
  "description": "Phase 1 - Foundation: Implement core types, config parsing, git operations, Claude wrapper, and engine skeleton",
  "userStories": [
    {
      "id": "US-001",
      "title": "Implement Space Types",
      "description": "As a developer, I need TypeScript types for space.toml so the resolver and materializer can work with typed Space objects.",
      "acceptanceCriteria": [
        "Space interface in packages/core/src/types/space.ts",
        "Includes: id, name, version, description",
        "Includes: deps.spaces as array of space refs",
        "Includes: components object (commands, agents, skills, hooks, mcp)",
        "Types exported from @asp/core",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Implement Targets Types",
      "description": "As a developer, I need TypeScript types for asp-targets.toml so the CLI can parse project configuration.",
      "acceptanceCriteria": [
        "TargetsConfig interface in packages/core/src/types/targets.ts",
        "Target interface with compose array of space refs",
        "Support for target inheritance via extends",
        "Types exported from @asp/core",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Implement Lock Types",
      "description": "As a developer, I need TypeScript types for asp-lock.json so the resolver can generate and read lock files.",
      "acceptanceCriteria": [
        "LockFile interface in packages/core/src/types/lock.ts",
        "SpaceEntry with id, version, commit, integrity",
        "envHash field for environment fingerprint",
        "loadOrder array with ordered space keys",
        "Types exported from @asp/core",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Implement Ref Types",
      "description": "As a developer, I need types for space references (space:<id>@<selector>) to parse and manipulate refs.",
      "acceptanceCriteria": [
        "SpaceRef interface in packages/core/src/types/refs.ts",
        "Selector union type: DistTagSelector | SemverSelector | GitPinSelector",
        "Parse function: parseSpaceRef(ref: string): SpaceRef",
        "Stringify function: stringifySpaceRef(ref: SpaceRef): string",
        "Types exported from @asp/core",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Implement TOML Parser for space.toml",
      "description": "As a developer, I need to parse space.toml files into typed Space objects.",
      "acceptanceCriteria": [
        "parseSpaceToml(content: string): Space function",
        "Uses @iarna/toml for parsing",
        "Validates against JSON schema using Ajv",
        "Throws ConfigError with helpful message on invalid input",
        "Unit tests for valid and invalid inputs",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Implement TOML Parser for asp-targets.toml",
      "description": "As a developer, I need to parse asp-targets.toml files into typed TargetsConfig objects.",
      "acceptanceCriteria": [
        "parseTargetsToml(content: string): TargetsConfig function",
        "Uses @iarna/toml for parsing",
        "Validates against JSON schema using Ajv",
        "Resolves extends inheritance between targets",
        "Throws ConfigError with helpful message on invalid input",
        "Unit tests for valid and invalid inputs",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Implement JSON Parser for asp-lock.json",
      "description": "As a developer, I need to parse and write asp-lock.json files.",
      "acceptanceCriteria": [
        "parseLockJson(content: string): LockFile function",
        "stringifyLockJson(lock: LockFile): string function (pretty-printed)",
        "Validates against JSON schema using Ajv",
        "Throws ConfigError on invalid input",
        "Unit tests for valid and invalid inputs",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Implement Error Classes",
      "description": "As a developer, I need typed error classes so errors are consistent and debuggable.",
      "acceptanceCriteria": [
        "AspError base class with code property",
        "ConfigError for config parsing failures",
        "ResolutionError for dependency resolution failures",
        "GitError for git operation failures",
        "MaterializationError for materialization failures",
        "All errors include helpful context (file path, line number if applicable)",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Implement File Locking",
      "description": "As a developer, I need file locking primitives so concurrent asp processes don't corrupt state.",
      "acceptanceCriteria": [
        "acquireProjectLock(projectPath: string): Promise<Lock> function",
        "acquireStoreLock(): Promise<Lock> function",
        "Lock has release() method",
        "Uses proper-lockfile under the hood",
        "Locks are automatically released on process exit",
        "Unit tests for lock acquisition and release",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement Atomic File Writes",
      "description": "As a developer, I need atomic file write utilities so interrupted writes don't leave corrupted files.",
      "acceptanceCriteria": [
        "atomicWriteFile(path: string, content: string): Promise<void> function",
        "Writes to <path>.tmp then renames",
        "Handles errors by cleaning up temp file",
        "Works on all platforms (macOS, Linux, Windows)",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement Safe Git Exec",
      "description": "As a developer, I need a safe git command executor that prevents shell injection.",
      "acceptanceCriteria": [
        "gitExec(args: string[], options?: GitExecOptions): Promise<GitResult> function",
        "Uses Bun.spawn with argv array (no shell)",
        "GitExecOptions includes cwd, timeout",
        "GitResult includes stdout, stderr, exitCode",
        "Throws GitError on non-zero exit",
        "Unit tests with mock git commands",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Implement Git Tag Operations",
      "description": "As a developer, I need to list and create git tags for version resolution.",
      "acceptanceCriteria": [
        "listTags(pattern: string, cwd: string): Promise<string[]> function",
        "createTag(name: string, commit: string, cwd: string): Promise<void> function",
        "Pattern supports glob matching (e.g., space/my-space/v*)",
        "Tags are created as lightweight tags (not annotated)",
        "Integration test with real git repo",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Implement Git Show",
      "description": "As a developer, I need to read file contents at specific commits.",
      "acceptanceCriteria": [
        "showFile(path: string, commit: string, cwd: string): Promise<string> function",
        "Returns file content as string",
        "Throws GitError if file doesn't exist at commit",
        "Integration test with real git repo",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Implement Git Tree Listing",
      "description": "As a developer, I need to list tree entries for integrity hashing.",
      "acceptanceCriteria": [
        "listTree(path: string, commit: string, cwd: string): Promise<TreeEntry[]> function",
        "TreeEntry includes path, mode, type, blobOid",
        "Recursive listing of all files in directory",
        "Integration test with real git repo",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Implement Git Archive",
      "description": "As a developer, I need to extract a directory tree at a commit to the filesystem.",
      "acceptanceCriteria": [
        "archive(path: string, commit: string, cwd: string, outDir: string): Promise<void> function",
        "Extracts to outDir preserving directory structure",
        "Handles file permissions correctly",
        "Integration test with real git repo",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Implement Git Repo Operations",
      "description": "As a developer, I need basic git repo operations (clone, fetch, init, status).",
      "acceptanceCriteria": [
        "clone(url: string, dest: string): Promise<void> function",
        "fetch(cwd: string, remote?: string): Promise<void> function",
        "init(cwd: string): Promise<void> function",
        "status(cwd: string): Promise<RepoStatus> function",
        "Integration tests with real git repos",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Implement Claude Detection",
      "description": "As a developer, I need to detect the Claude CLI binary and its capabilities.",
      "acceptanceCriteria": [
        "detectClaude(): Promise<ClaudeInfo | null> function",
        "Checks ASP_CLAUDE_PATH env var first",
        "Falls back to which claude",
        "ClaudeInfo includes path, version, supportsPluginDir",
        "Returns null if not found (doesn't throw)",
        "Unit tests with mocked environment",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Implement Claude Invocation",
      "description": "As a developer, I need to safely invoke Claude with plugin directories.",
      "acceptanceCriteria": [
        "invokeClaude(options: InvokeOptions): Promise<void> function",
        "InvokeOptions includes pluginDirs, mcpConfig, args",
        "Uses argv array (no shell)",
        "Forwards stdio to parent process",
        "Waits for Claude to exit",
        "Throws if Claude not found",
        "Integration test with claude-shim",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Implement Engine Orchestration Skeleton",
      "description": "As a developer, I need the engine package to provide high-level orchestration functions.",
      "acceptanceCriteria": [
        "resolve(target: string, options: ResolveOptions): Promise<ResolvedGraph> stub",
        "install(options: InstallOptions): Promise<void> stub",
        "build(target: string, options: BuildOptions): Promise<BuildResult> stub",
        "run(target: string, options: RunOptions): Promise<void> stub",
        "explain(target: string, options: ExplainOptions): Promise<ExplainResult> stub",
        "All functions throw 'not implemented' for now",
        "Types defined for all options and results",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    }
  ]
}
