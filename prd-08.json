{
  "project": "Agent Spaces v2",
  "branchName": "ralph/phase-8-integration-tests",
  "description": "Phase 8 - Integration Tests: Comprehensive end-to-end tests with claude-shim",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create Test Fixtures Directory Structure",
      "description": "As a developer, I need test fixtures to run integration tests against.",
      "acceptanceCriteria": [
        "integration-tests/fixtures/ directory",
        "fixtures/sample-registry/ - git repo with test spaces",
        "fixtures/sample-project/ - project with asp-targets.toml",
        "fixtures/claude-shim/ - mock claude executable",
        "All fixtures committed to repo",
        "Fixtures documented in README",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Create Sample Registry Fixture",
      "description": "As a developer, I need a sample registry for testing resolution.",
      "acceptanceCriteria": [
        "Git repo with proper structure",
        "registry/dist-tags.json with test entries",
        "spaces/base/ - minimal space with no deps",
        "spaces/frontend/ - space that depends on base",
        "spaces/backend/ - space with commands and hooks",
        "spaces/circular-a/ and spaces/circular-b/ - for cycle testing",
        "spaces/with-mcp/ - space with MCP config",
        "Multiple version tags per space",
        "Fixture setup script to initialize git repo",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create Sample Project Fixture",
      "description": "As a developer, I need a sample project for testing project-mode commands.",
      "acceptanceCriteria": [
        "asp-targets.toml with multiple targets",
        "Target that composes multiple spaces",
        "Target that uses semver range",
        "Target that uses dist-tag",
        "No asp-lock.json (generated by tests)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Implement Claude Shim",
      "description": "As a developer, I need a mock claude executable for testing.",
      "acceptanceCriteria": [
        "Executable script at fixtures/claude-shim/claude",
        "Records all arguments to a temp file",
        "Validates --plugin-dir paths exist",
        "Validates plugin.json exists in each plugin dir",
        "Exits 0 on success",
        "Respects ASP_CLAUDE_PATH env var",
        "Works on macOS and Linux",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Implement Test Harness",
      "description": "As a developer, I need a test harness for running asp commands.",
      "acceptanceCriteria": [
        "runAsp(args: string[], options?: RunOptions): Promise<RunResult> helper",
        "Sets ASP_HOME to temp directory",
        "Sets ASP_CLAUDE_PATH to shim",
        "Captures stdout and stderr",
        "Returns exit code",
        "Cleans up temp directories after test",
        "Supports custom env vars",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Test asp install Flow",
      "description": "As a developer, I need to verify asp install works correctly.",
      "acceptanceCriteria": [
        "Test: install in project generates asp-lock.json",
        "Test: lock file has correct structure",
        "Test: lock file has correct load order",
        "Test: store is populated with snapshots",
        "Test: second install is fast (cache hit)",
        "Test: install with invalid target fails with clear error",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Test asp run Flow",
      "description": "As a developer, I need to verify asp run invokes Claude correctly.",
      "acceptanceCriteria": [
        "Test: run target invokes claude with --plugin-dir flags",
        "Test: plugin dirs are in correct load order",
        "Test: plugins contain valid plugin.json",
        "Test: MCP config is passed when present",
        "Test: run with invalid target fails",
        "Test: run in global mode works",
        "Verify via shim's recorded arguments",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Test asp build Flow",
      "description": "As a developer, I need to verify asp build materializes correctly.",
      "acceptanceCriteria": [
        "Test: build creates output directory",
        "Test: output contains one dir per space",
        "Test: each dir has .claude-plugin/plugin.json",
        "Test: components are present",
        "Test: build does NOT invoke claude",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Test asp explain Flow",
      "description": "As a developer, I need to verify asp explain shows correct info.",
      "acceptanceCriteria": [
        "Test: explain shows resolved versions",
        "Test: explain shows load order",
        "Test: explain --json outputs valid JSON",
        "Test: JSON contains expected fields",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Test Resolution Edge Cases",
      "description": "As a developer, I need to verify resolution handles edge cases.",
      "acceptanceCriteria": [
        "Test: circular dependency fails with clear error",
        "Test: error message includes cycle path",
        "Test: diamond dependency resolves correctly",
        "Test: missing space fails with clear error",
        "Test: invalid semver range fails",
        "Test: unknown dist-tag fails",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Test asp add/remove/upgrade",
      "description": "As a developer, I need to verify target modification commands.",
      "acceptanceCriteria": [
        "Test: add updates asp-targets.toml correctly",
        "Test: add runs install after update",
        "Test: remove updates asp-targets.toml correctly",
        "Test: remove fails if space not in target",
        "Test: upgrade updates lock file",
        "Test: upgrade respects semver ranges",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Test asp diff",
      "description": "As a developer, I need to verify diff shows correct changes.",
      "acceptanceCriteria": [
        "Test: diff shows added spaces",
        "Test: diff shows removed spaces",
        "Test: diff shows upgraded spaces",
        "Test: diff does not modify files",
        "Test: diff --json outputs valid JSON",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Test asp lint",
      "description": "As a developer, I need to verify lint detects issues.",
      "acceptanceCriteria": [
        "Test: lint detects command name collision (W201)",
        "Test: lint detects missing plugin root in hooks (W203)",
        "Test: lint detects invalid hooks config (W204)",
        "Test: lint detects plugin name collision (W205)",
        "Test: lint passes on valid project",
        "Test: lint --json outputs valid JSON",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Test asp repo Commands",
      "description": "As a developer, I need to verify repo management commands.",
      "acceptanceCriteria": [
        "Test: repo init creates registry structure",
        "Test: repo init creates dist-tags.json",
        "Test: repo publish creates git tag",
        "Test: repo publish updates dist-tags.json",
        "Test: repo tags lists versions correctly",
        "Test: repo status shows correct info",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Test Cache Behavior",
      "description": "As a developer, I need to verify caching works correctly.",
      "acceptanceCriteria": [
        "Test: first materialization populates cache",
        "Test: second materialization uses cache (fast)",
        "Test: cache key changes when space content changes",
        "Test: gc removes unreferenced entries",
        "Test: gc preserves referenced entries",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Test Real Claude (Optional)",
      "description": "As a developer, I need optional tests with real Claude for validation.",
      "acceptanceCriteria": [
        "Tests in run-real-claude.test.ts",
        "Skipped by default",
        "Enabled with RUN_REAL_CLAUDE=1 env var",
        "Test: Claude boots with plugins",
        "Test: /plugin:command is available",
        "Test: MCP servers connect (if configured)",
        "Tests must be idempotent",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Implement CI Configuration",
      "description": "As a developer, I need CI to run integration tests.",
      "acceptanceCriteria": [
        "GitHub Actions workflow file",
        "Runs on push and PR",
        "Sets up Bun",
        "Runs unit tests",
        "Runs integration tests with shim",
        "Caches dependencies",
        "Reports test results",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    }
  ]
}
