# Agent Spaces Usage Guide

Complete reference for the `asp` command-line tool.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Getting Started](#getting-started)
- [Project Configuration](#project-configuration)
- [Command Reference](#command-reference)
  - [Core Commands](#core-commands)
  - [Management Commands](#management-commands)
  - [Inspection Commands](#inspection-commands)
  - [Maintenance Commands](#maintenance-commands)
  - [Repository Commands](#repository-commands)
- [Space Authoring](#space-authoring)
- [Configuration](#configuration)
- [Troubleshooting](#troubleshooting)

---

## Prerequisites

1. **Bun** >= 1.0 — [Install Bun](https://bun.sh/)
2. **Claude Code** CLI — [Install Claude Code](https://claude.ai/code)
3. **OpenAI Codex** CLI >= 0.1.0 (optional) — required for `--harness codex` runs (experimental)
4. **Pi SDK** (optional) — required for `--harness pi-sdk` runs

Verify your setup:

```bash
asp doctor
```

---

## Getting Started

### 1. Initialize Your Registry

The registry is a git repository that stores your spaces. Initialize it once:

```bash
asp repo init
```

This creates `~/.asp/repo` with:
- The `agent-spaces-manager` space (pre-installed)
- A `registry/dist-tags.json` for channel management
- Standard directory structure

To clone an existing registry instead:

```bash
asp repo init --clone git@github.com:your-org/spaces-registry.git
```

### 2. Create Your First Space

Run the manager space to get guided help:

```bash
asp run space:agent-spaces-manager@stable
```

Or manually create a space in `~/.asp/repo/spaces/my-space/`:

```
my-space/
├── space.toml           # Required: space manifest
├── commands/            # Slash commands (markdown files)
│   └── hello.md
├── skills/              # Skills (SKILL.md in subdirs)
├── agents/              # Agent definitions
└── hooks/               # Event hooks
    └── hooks.json
```

**space.toml:**

```toml
schema = 1
id = "my-space"
version = "1.0.0"
description = "My first space"

[plugin]
name = "my-space"
```

### 3. Publish Your Space

```bash
cd ~/.asp/repo
git add spaces/my-space
git commit -m "feat: Add my-space"

asp repo publish my-space --tag v1.0.0 --dist-tag stable
```

### 4. Use in a Project

Create `asp-targets.toml` in your project:

```toml
schema = 1

[targets.default]
compose = ["space:my-space@stable"]
```

Run it:

```bash
asp install   # Lock dependencies
asp run default
```

---

## Project Configuration

### asp-targets.toml

The project manifest defines run targets. Place it in your project root.

```toml
schema = 1

[targets.default]
description = "Default development environment"
compose = [
  "space:base-tools@stable",
  "space:project-helpers@^1.0.0"
]

[targets.frontend]
description = "Frontend development"
compose = [
  "space:base-tools@stable",
  "space:react-helpers@latest"
]

[targets.backend]
description = "Backend development"
compose = [
  "space:base-tools@stable",
  "space:api-tools@stable"
]
```

### Space References

Space references follow the format `space:<id>@<selector>`:

| Selector | Example | Description |
|----------|---------|-------------|
| Dist-tag | `@stable` | Channel pointer (stable, latest, beta) |
| Semver range | `@^1.0.0` | Highest matching version |
| Exact version | `@v1.2.3` | Specific version tag |
| Git SHA | `@abc1234` | Exact commit |

### asp-lock.json

Generated by `asp install`. Locks exact versions for reproducibility. Commit this file to version control.

---

## Command Reference

### Core Commands

#### asp run

Launch Claude with composed spaces.

```bash
# Project mode: run a target from asp-targets.toml
asp run <target> [prompt]

# Global mode: run a space directly (no project needed)
asp run space:my-space@stable

# Dev mode: run a local space directory
asp run ./path/to/space
```

**Options:**

| Option | Description |
|--------|-------------|
| `--harness <id>` | Harness to use (claude, codex, pi, pi-sdk) |
| `--model <model>` | Model override (pi-sdk expects provider:model) |
| `--no-interactive` | Run non-interactively (requires prompt argument) |
| `--no-warnings` | Suppress lint warnings |
| `--project <path>` | Project directory (default: auto-detect) |
| `--registry <path>` | Registry path override |
| `--asp-home <path>` | ASP_HOME override |
| `--extra-args <args...>` | Additional harness CLI arguments |

**Examples:**

```bash
# Interactive session
asp run default

# One-shot with prompt
asp run default "Review this PR"

# Pass extra args to Claude
asp run default --extra-args --verbose --dangerously-skip-permissions
```

---

#### asp install

Resolve targets and generate/update the lock file.

```bash
asp install [options]
```

**Options:**

| Option | Description |
|--------|-------------|
| `--targets <names...>` | Specific targets to install |
| `--harness <id>` | Harness to use (claude, codex, pi, pi-sdk) |
| `--update` | Re-resolve selectors (update lock) |
| `--no-fetch` | Skip fetching registry updates |
| `--project <path>` | Project directory |
| `--registry <path>` | Registry path override |
| `--asp-home <path>` | ASP_HOME override |

**Examples:**

```bash
# Install all targets
asp install

# Install specific target
asp install --targets frontend

# Update to latest matching versions
asp install --update
```

---

#### asp build

Materialize plugins without launching Claude. Useful for inspection or CI.

```bash
asp build [target] --output <dir>
```

**Options:**

| Option | Description |
|--------|-------------|
| `--output <dir>` | Output directory (required) |
| `--harness <id>` | Harness to use (claude, codex, pi, pi-sdk) |
| `--no-clean` | Keep existing output directory |
| `--no-install` | Skip auto-install if lock missing |
| `--no-lint` | Skip lint checks |
| `--project <path>` | Project directory |
| `--registry <path>` | Registry path override |
| `--asp-home <path>` | ASP_HOME override |

**Examples:**

```bash
# Build specific target
asp build frontend --output ./plugins

# Build all targets
asp build --output ./plugins
```

---

### Management Commands

#### asp add

Add a space reference to a target.

```bash
asp add <spaceRef> --target <name>
```

**Options:**

| Option | Description |
|--------|-------------|
| `--target <name>` | Target to add the space to (required) |
| `--no-install` | Skip running install after adding |
| `--project <path>` | Project directory |

**Examples:**

```bash
asp add space:testing-tools@stable --target default
asp add space:react-helpers@^2.0.0 --target frontend
```

---

#### asp remove

Remove a space from a target.

```bash
asp remove <spaceId> --target <name>
```

**Options:**

| Option | Description |
|--------|-------------|
| `--target <name>` | Target to remove the space from (required) |
| `--no-install` | Skip running install after removing |
| `--project <path>` | Project directory |

**Examples:**

```bash
asp remove testing-tools --target default
```

---

#### asp upgrade

Update lock file to latest versions matching selectors.

```bash
asp upgrade [spaceIds...]
```

**Options:**

| Option | Description |
|--------|-------------|
| `--target <name>` | Limit to specific target |
| `--project <path>` | Project directory |
| `--registry <path>` | Registry path override |
| `--asp-home <path>` | ASP_HOME override |

**Examples:**

```bash
# Upgrade all spaces
asp upgrade

# Upgrade specific spaces only
asp upgrade react-helpers api-tools

# Upgrade only in frontend target
asp upgrade --target frontend
```

---

### Inspection Commands

#### asp explain

Show resolved graph, pins, load order, and warnings.

```bash
asp explain [target]
```

**Options:**

| Option | Description |
|--------|-------------|
| `--harness <id>` | Harness to use (claude, codex, pi, pi-sdk) |
| `--json` | Output as JSON |
| `--no-store-check` | Skip checking if snapshots are in store |
| `--no-lint` | Skip lint checks |
| `--project <path>` | Project directory |

**Examples:**

```bash
# Explain all targets
asp explain

# Explain specific target as JSON
asp explain frontend --json
```

---

#### asp lint

Validate targets and detect conflicts.

```bash
asp lint [target]
```

**Options:**

| Option | Description |
|--------|-------------|
| `--json` | Output as JSON |
| `--project <path>` | Project directory |

**Warning Codes:**

| Code | Description |
|------|-------------|
| W101 | Lock file missing (info level) |
| W201 | Command collision — same command in multiple spaces |
| W202 | Agent references unqualified `/command` from plugin |
| W203 | Hook path missing `${CLAUDE_PLUGIN_ROOT}` |
| W204 | hooks/ exists but hooks.json missing or invalid |
| W205 | Plugin name collision — two spaces produce same name |
| W206 | Non-executable hook script |
| W207 | Component directories nested inside .claude-plugin/ |
| W301 | Pi: Hook marked blocking but event cannot block |
| W302 | Pi: Extension registers un-namespaced tool |
| W303 | Pi: Tool name collision after namespacing |

---

#### asp list

List targets, resolved spaces, and status.

```bash
asp list
```

**Options:**

| Option | Description |
|--------|-------------|
| `--json` | Output as JSON |
| `--project <path>` | Project directory |
| `--asp-home <path>` | ASP_HOME override |

---

#### asp diff

Show what would change in the lock file.

```bash
asp diff
```

**Options:**

| Option | Description |
|--------|-------------|
| `--target <name>` | Specific target to check |
| `--json` | Output as JSON |
| `--project <path>` | Project directory |

**Example output:**

```
Target: default
  + new-space v1.0.0
  ~ existing-space v1.0.0 -> v1.1.0
  - removed-space v0.9.0
```

---

#### asp doctor

Check system health: Claude binary, registry, cache permissions.

```bash
asp doctor
```

**Options:**

| Option | Description |
|--------|-------------|
| `--json` | Output as JSON |
| `--project <path>` | Project directory |
| `--asp-home <path>` | ASP_HOME override |

**Checks performed:**

- Claude binary found and version detected
- ASP_HOME directory exists and writable
- Cache and store directories accessible
- Registry exists and remote reachable
- Project detected (if in project directory)

---

### Maintenance Commands

#### asp gc

Garbage collect unreferenced store and cache entries.

```bash
asp gc
```

**Options:**

| Option | Description |
|--------|-------------|
| `--dry-run` | Show what would be deleted |
| `--project <path>` | Project directory |
| `--asp-home <path>` | ASP_HOME override |

---

### Repository Commands

#### asp repo init

Initialize or clone a spaces registry.

```bash
asp repo init
```

**Options:**

| Option | Description |
|--------|-------------|
| `--clone <url>` | Clone from existing registry URL |
| `--asp-home <path>` | ASP_HOME override |
| `--no-manager` | Skip installing the manager space |

---

#### asp repo status

Show registry status: spaces, dist-tags, git status.

```bash
asp repo status
```

**Options:**

| Option | Description |
|--------|-------------|
| `--json` | Output as JSON |
| `--asp-home <path>` | ASP_HOME override |

---

#### asp repo publish

Create a version tag and optionally update dist-tags.

```bash
asp repo publish <spaceId> --tag <version>
```

**Options:**

| Option | Description |
|--------|-------------|
| `--tag <version>` | Version tag, e.g., v1.0.0 (required) |
| `--dist-tag <name>` | Also update dist-tag (stable, latest, etc.) |
| `--asp-home <path>` | ASP_HOME override |

**Examples:**

```bash
# Create version tag only
asp repo publish my-space --tag v1.0.0

# Create tag and update stable channel
asp repo publish my-space --tag v1.0.0 --dist-tag stable

# Prerelease
asp repo publish my-space --tag v2.0.0-beta.1 --dist-tag beta
```

After publishing, commit and push:

```bash
cd ~/.asp/repo
git add registry/dist-tags.json
git commit -m "chore: Update dist-tags"
git push origin main --tags
```

---

#### asp repo tags

List version tags for a space.

```bash
asp repo tags <spaceId>
```

**Options:**

| Option | Description |
|--------|-------------|
| `--json` | Output as JSON |
| `--asp-home <path>` | ASP_HOME override |

---

#### asp repo gc

Run garbage collection on the registry repository.

```bash
asp repo gc
```

**Options:**

| Option | Description |
|--------|-------------|
| `--dry-run` | Show what would be done |
| `--prune-global-lock` | Also clean up global lock entries |
| `--asp-home <path>` | ASP_HOME override |

---

## Space Authoring

### Space Structure

```
my-space/
├── space.toml              # Required manifest
├── commands/               # Slash commands
│   ├── build.md
│   └── deploy.md
├── skills/                 # Skills
│   └── code-review/
│       └── SKILL.md
├── agents/                 # Agent definitions
│   └── architect.md
├── hooks/                  # Event hooks
│   ├── hooks.json
│   └── scripts/
│       └── pre-commit.sh
└── mcp/                    # MCP server configs
    └── servers.json
```

### space.toml Schema

```toml
schema = 1
id = "my-space"              # Unique identifier (kebab-case)
version = "1.0.0"            # Semver version
description = "Description"

[plugin]
name = "my-space"            # Plugin name (defaults to id)
version = "1.0.0"            # Plugin version (defaults to space version)

[deps]
spaces = [                   # Dependencies on other spaces
  "space:base-tools@stable"
]
```

### Commands

Create markdown files in `commands/`. The filename (without `.md`) becomes the command name.

```markdown
# /build

Build the project.

## Usage

Run this command to build the project with the current configuration.

## Steps

1. Run `npm run build`
2. Check for errors
3. Report results
```

### Hooks

Create `hooks/hooks.json`:

```json
{
  "hooks": [
    {
      "event": "on_message_submit",
      "scripts": ["${CLAUDE_PLUGIN_ROOT}/hooks/scripts/validate.sh"]
    }
  ]
}
```

Make scripts executable:

```bash
chmod +x hooks/scripts/*.sh
```

---

## Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `ASP_HOME` | Root directory for registry, store, cache | `~/.asp` |
| `ASP_CLAUDE_PATH` | Override Claude binary path | Auto-detected |

### ASP Home Structure

```
~/.asp/
├── repo/                    # Registry git clone
├── store/<hash>/            # Content-addressed snapshots
├── cache/<cacheKey>/        # Materialized plugin directories
├── tmp/                     # Temporary files
├── global-lock.json         # Pins for global-mode runs
└── config.json              # Optional global config
```

---

## Troubleshooting

### "No asp-targets.toml found"

You're not in a project directory. Either:
- `cd` to a directory with `asp-targets.toml`
- Use `--project <path>` to specify the project
- Use global mode: `asp run space:my-space@stable`

### "Claude not found"

Run `asp doctor` to diagnose. Ensure Claude Code CLI is installed and in your PATH, or set `ASP_CLAUDE_PATH`.

### "Registry not found"

Run `asp repo init` to create the registry at `~/.asp/repo`.

### Command collisions (W201)

Two spaces define the same command. Use fully-qualified names:
```
/space-a:deploy
/space-b:deploy
```

Or remove one space from your target composition.

### Lock file out of date

```bash
asp diff      # See what would change
asp upgrade   # Update to latest matching versions
```

### Cache issues

```bash
asp gc --dry-run   # See what would be cleaned
asp gc             # Clean unreferenced entries
```
