{
  "project": "Agent Spaces v2",
  "branchName": "ralph/phase-4-materialization",
  "description": "Phase 4 - Materialization: Transform stored snapshots into Claude Code plugin directories with caching",
  "userStories": [
    {
      "id": "US-001",
      "title": "Implement Plugin JSON Generation",
      "description": "As a developer, I need to generate .claude-plugin/plugin.json from a space's manifest.",
      "acceptanceCriteria": [
        "generatePluginJson(space: Space): PluginManifest function in packages/materializer/src/plugin-json.ts",
        "name is required, derived from space.id (kebab-case)",
        "version optional, from space.version",
        "description optional, from space.description",
        "Respects pluginManifest overrides in space.toml",
        "Output matches Claude Code plugin.json schema",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Implement Plugin JSON Writer",
      "description": "As a developer, I need to write the plugin.json to the correct location.",
      "acceptanceCriteria": [
        "writePluginJson(manifest: PluginManifest, pluginDir: string): Promise<void> function",
        "Writes to <pluginDir>/.claude-plugin/plugin.json",
        "Creates .claude-plugin directory if needed",
        "Pretty-prints JSON (2-space indent)",
        "Atomic write (temp file + rename)",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Implement Hardlink Component Copier",
      "description": "As a developer, I need to link components from store to plugin dir using hardlinks.",
      "acceptanceCriteria": [
        "linkComponents(snapshotPath: string, pluginDir: string, options: LinkOptions): Promise<LinkResult> function",
        "Creates hardlinks for all files in commands/, agents/, skills/, hooks/, scripts/",
        "Preserves directory structure",
        "Preserves file permissions (especially executable bits)",
        "LinkResult includes linkedFiles, linkedBytes",
        "Returns success even if some components don't exist",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Implement Fallback Copy",
      "description": "As a developer, I need to fall back to copying when hardlinks fail.",
      "acceptanceCriteria": [
        "copyComponents(snapshotPath: string, pluginDir: string): Promise<CopyResult> function",
        "Copies all component directories",
        "Preserves directory structure",
        "Preserves file permissions",
        "CopyResult includes copiedFiles, copiedBytes",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Implement Smart Component Transfer",
      "description": "As a developer, I need a unified function that tries hardlink first, falls back to copy.",
      "acceptanceCriteria": [
        "transferComponents(snapshotPath: string, pluginDir: string): Promise<TransferResult> function",
        "Attempts hardlink first",
        "Falls back to copy if hardlink fails (cross-device, permissions, etc.)",
        "TransferResult includes method: 'hardlink' | 'copy', file counts",
        "Logs which method was used",
        "Unit tests for both paths",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Implement Hooks Validator",
      "description": "As a developer, I need to validate hooks configuration before materialization.",
      "acceptanceCriteria": [
        "validateHooks(snapshotPath: string): Promise<HooksValidation> function in packages/materializer/src/hooks-builder.ts",
        "If hooks/ exists, hooks/hooks.json must exist",
        "Validates hooks.json against Claude Code hooks schema",
        "Checks all referenced scripts exist",
        "HooksValidation includes valid: boolean, errors: string[], warnings: string[]",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Implement Hook Script Permissions",
      "description": "As a developer, I need to ensure hook scripts are executable.",
      "acceptanceCriteria": [
        "ensureHooksExecutable(pluginDir: string): Promise<void> function",
        "Reads hooks/hooks.json to find script paths",
        "Sets executable bit on all referenced scripts",
        "Handles scripts without executable bit gracefully",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Implement Hook Path Validation",
      "description": "As a developer, I need to validate that hook paths use ${CLAUDE_PLUGIN_ROOT}.",
      "acceptanceCriteria": [
        "Part of validateHooks function",
        "Checks that hook command paths start with ${CLAUDE_PLUGIN_ROOT}",
        "Returns warning (not error) if missing (for lint rule W203)",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Implement MCP Config Reader",
      "description": "As a developer, I need to read MCP configuration from a space.",
      "acceptanceCriteria": [
        "readMcpConfig(snapshotPath: string): Promise<McpConfig | null> function in packages/materializer/src/mcp-composer.ts",
        "Reads mcp/mcp.json if it exists",
        "Validates against MCP config schema",
        "Returns null if file doesn't exist (not all spaces have MCP)",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement MCP Config Composer",
      "description": "As a developer, I need to compose MCP configs from multiple spaces into one.",
      "acceptanceCriteria": [
        "composeMcpConfigs(configs: McpConfig[], loadOrder: string[]): McpConfig function",
        "Merges mcpServers objects from all configs",
        "Later spaces in load order override earlier ones (if same server name)",
        "Preserves all server configuration",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement MCP Config Writer",
      "description": "As a developer, I need to write the composed MCP config to a file for Claude.",
      "acceptanceCriteria": [
        "writeMcpConfig(config: McpConfig, outputPath: string): Promise<void> function",
        "Writes JSON to specified path",
        "Atomic write",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Implement Materialization Cache Key",
      "description": "As a developer, I need to compute cache keys for materialized plugins.",
      "acceptanceCriteria": [
        "computeCacheKey(integrity: string, pluginName: string, materializerVersion: string): string function in packages/materializer/src/cache.ts",
        "Hash of: materializer version + space integrity + plugin name",
        "Format: sha256-<hex> (truncated to 16 chars for readability)",
        "Deterministic",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Implement Cache Lookup",
      "description": "As a developer, I need to look up cached materialized plugins.",
      "acceptanceCriteria": [
        "lookupCache(cacheKey: string, pluginName: string): string | null function",
        "Returns path if cached plugin exists",
        "Validates plugin structure (has .claude-plugin/plugin.json)",
        "Returns null if not cached or invalid",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Implement Cache Storage",
      "description": "As a developer, I need to store materialized plugins in the cache.",
      "acceptanceCriteria": [
        "storeInCache(pluginDir: string, cacheKey: string, pluginName: string): Promise<string> function",
        "Copies/moves plugin dir to cache location",
        "Returns cache path",
        "Handles concurrent storage (second process uses existing)",
        "Atomic storage",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Implement Full Materialization Pipeline",
      "description": "As a developer, I need a single function that materializes a space to a plugin directory.",
      "acceptanceCriteria": [
        "materialize(snapshot: SnapshotInfo, options: MaterializeOptions): Promise<MaterializeResult> function in packages/materializer/src/index.ts",
        "Checks cache first, returns cached if hit",
        "Creates temp directory for atomic materialization",
        "Generates plugin.json",
        "Transfers components (hardlink/copy)",
        "Validates and processes hooks",
        "Stores in cache",
        "MaterializeResult includes pluginPath, cached: boolean, warnings: string[]",
        "Integration test",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Implement Multi-Space Materialization",
      "description": "As a developer, I need to materialize multiple spaces with MCP composition.",
      "acceptanceCriteria": [
        "materializeAll(snapshots: SnapshotInfo[], loadOrder: string[]): Promise<MaterializeAllResult> function",
        "Materializes each space",
        "Composes MCP configs from all spaces",
        "Writes composed MCP config",
        "MaterializeAllResult includes pluginPaths: string[], mcpConfigPath: string | null",
        "Integration test",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    }
  ]
}
