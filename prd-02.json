{
  "project": "Agent Spaces v2",
  "branchName": "ralph/phase-2-resolution",
  "description": "Phase 2 - Resolution Engine: Parse refs, resolve selectors, compute dependency closure, detect cycles, generate lock files",
  "userStories": [
    {
      "id": "US-001",
      "title": "Implement Ref Parser",
      "description": "As a developer, I need to parse space reference strings into structured objects for processing.",
      "acceptanceCriteria": [
        "parseRef(ref: string): SpaceRef function in packages/resolver/src/ref-parser.ts",
        "Parses space:my-space@stable correctly",
        "Parses space:my-space@^1.0.0 correctly",
        "Parses space:my-space@git:abc123 correctly",
        "Parses space:my-space (no selector) defaults to @stable",
        "Throws ResolutionError on invalid format",
        "Unit tests for all cases",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Implement Dist-Tag Reader",
      "description": "As a developer, I need to read dist-tags from the registry's committed metadata file.",
      "acceptanceCriteria": [
        "readDistTags(repoPath: string): Promise<DistTagsMap> function",
        "Reads registry/dist-tags.json from HEAD commit",
        "Returns { [spaceId]: { [tag]: version } } structure",
        "Returns empty map if file doesn't exist (new registry)",
        "Caches result for duration of resolution",
        "Unit tests with mock git",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Implement Dist-Tag Resolution",
      "description": "As a developer, I need to resolve dist-tags (stable, latest, beta) to specific versions.",
      "acceptanceCriteria": [
        "resolveDistTag(spaceId: string, tag: string, distTags: DistTagsMap): string function",
        "Returns version string (e.g., v1.2.3) for the tag",
        "Throws ResolutionError if space not found in dist-tags",
        "Throws ResolutionError if tag not found for space",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Implement Semver Tag Discovery",
      "description": "As a developer, I need to discover all version tags for a space from git.",
      "acceptanceCriteria": [
        "discoverVersions(spaceId: string, repoPath: string): Promise<VersionInfo[]> function",
        "Lists tags matching space/<id>/v*",
        "Parses version from tag name",
        "Returns array with { version: string, tag: string, commit: string }",
        "Sorted by semver descending (newest first)",
        "Unit tests with mock git",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Implement Semver Resolution",
      "description": "As a developer, I need to resolve semver ranges to specific versions.",
      "acceptanceCriteria": [
        "resolveSemver(spaceId: string, range: string, versions: VersionInfo[]): VersionInfo function",
        "Uses semver.maxSatisfying to find best match",
        "Throws ResolutionError if no version satisfies range",
        "Handles exact versions, ranges (^1.0.0), and wildcards (*)",
        "Unit tests for various semver scenarios",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Implement Git Pin Resolution",
      "description": "As a developer, I need to resolve git:<sha> pins to commits.",
      "acceptanceCriteria": [
        "resolveGitPin(spaceId: string, sha: string, repoPath: string): Promise<ResolvedSpace> function",
        "Validates commit exists in repo",
        "Reads space.toml at that commit",
        "Returns resolved space with commit info",
        "Throws ResolutionError if commit not found",
        "Unit tests with mock git",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Implement Unified Selector Resolution",
      "description": "As a developer, I need a single function that resolves any selector type.",
      "acceptanceCriteria": [
        "resolveSelector(ref: SpaceRef, context: ResolutionContext): Promise<ResolvedSpace> function",
        "Dispatches to dist-tag, semver, or git pin resolver based on selector type",
        "ResolutionContext includes repoPath, distTags, cached versions",
        "ResolvedSpace includes id, version, commit, space (parsed space.toml)",
        "Caches resolution results to avoid redundant git operations",
        "Unit tests for all selector types",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Implement Dependency Closure",
      "description": "As a developer, I need to compute the full dependency graph with load order.",
      "acceptanceCriteria": [
        "computeClosure(roots: SpaceRef[], context: ResolutionContext): Promise<Closure> function",
        "Uses DFS postorder traversal",
        "Processes dependencies in declared order",
        "Closure includes loadOrder: ResolvedSpace[] (dependencies before dependents)",
        "Closure includes graph: Map<string, ResolvedSpace> keyed by spaceKey",
        "Handles diamond dependencies (same space via multiple paths)",
        "Unit tests for various graph structures",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Implement Cycle Detection",
      "description": "As a developer, I need cycle detection that fails fast with a clear error.",
      "acceptanceCriteria": [
        "Cycle detection integrated into computeClosure",
        "Detects cycles during DFS traversal (back edge detection)",
        "Throws ResolutionError with cycle path (A -> B -> C -> A)",
        "Fails on first cycle found (no need to find all cycles)",
        "Unit tests for cyclic graphs",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement Lock File Generation",
      "description": "As a developer, I need to generate asp-lock.json from a resolved closure.",
      "acceptanceCriteria": [
        "generateLock(closure: Closure, existingLock?: LockFile): LockFile function",
        "Generates spaces map with all resolved spaces",
        "Each entry has id, version, commit, integrity (placeholder for Phase 3)",
        "Generates loadOrder array in correct order",
        "Generates envHash (placeholder for Phase 3)",
        "Preserves manually-pinned entries from existing lock if compatible",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement Lock File Diff",
      "description": "As a developer, I need to compute differences between lock files for asp diff.",
      "acceptanceCriteria": [
        "diffLocks(oldLock: LockFile, newLock: LockFile): LockDiff function",
        "LockDiff includes added, removed, changed space entries",
        "changed includes old and new version/commit",
        "Human-readable format method",
        "JSON format method",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Implement Structural Validator",
      "description": "As a developer, I need validation of the resolved graph structure (errors only, not warnings).",
      "acceptanceCriteria": [
        "validateClosure(closure: Closure): ValidationResult function",
        "Checks all deps are resolved (no dangling refs)",
        "Checks space.toml is valid for each resolved space",
        "ValidationResult includes errors: ValidationError[]",
        "Does NOT include warnings (warnings are in lint package)",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Implement Target Resolution",
      "description": "As a developer, I need to resolve a named target from asp-targets.toml.",
      "acceptanceCriteria": [
        "resolveTarget(targetName: string, config: TargetsConfig, context: ResolutionContext): Promise<Closure> function",
        "Resolves target's compose array as roots",
        "Handles extends inheritance",
        "Returns full closure",
        "Throws ResolutionError if target not found",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Implement Global Mode Resolution",
      "description": "As a developer, I need to resolve a single space ref in global mode (outside a project).",
      "acceptanceCriteria": [
        "resolveGlobal(ref: SpaceRef, context: ResolutionContext): Promise<Closure> function",
        "Resolves single space ref as root",
        "Uses global lock file at $ASP_HOME/global-lock.json",
        "Returns full closure with dependencies",
        "Unit tests",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    }
  ]
}
