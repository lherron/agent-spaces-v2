#!/bin/bash
# Claude CLI shim for integration testing
#
# WHY: This shim allows us to test the full asp run flow without
# invoking the real Claude CLI. It records the arguments it receives
# to a file for assertions and optionally validates plugin directories.
#
# USAGE:
#   Set ASP_CLAUDE_PATH to point to this script
#   The shim will write argv to CLAUDE_SHIM_OUTPUT (default: /tmp/claude-shim-output.json)
#
# ENVIRONMENT:
#   CLAUDE_SHIM_OUTPUT - File to write output (default: /tmp/claude-shim-output.json)
#   CLAUDE_SHIM_EXIT_CODE - Exit code to return (default: 0)
#   CLAUDE_SHIM_VALIDATE_PLUGINS - If set to "1", validate plugin directories exist

OUTPUT_FILE="${CLAUDE_SHIM_OUTPUT:-/tmp/claude-shim-output.json}"
EXIT_CODE="${CLAUDE_SHIM_EXIT_CODE:-0}"
VALIDATE_PLUGINS="${CLAUDE_SHIM_VALIDATE_PLUGINS:-0}"

# Build JSON array of arguments
ARGS_JSON="["
FIRST=true
for arg in "$@"; do
  if [ "$FIRST" = true ]; then
    FIRST=false
  else
    ARGS_JSON+=","
  fi
  # Escape special characters in the argument
  ESCAPED_ARG=$(printf '%s' "$arg" | sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g; s/\n/\\n/g')
  ARGS_JSON+="\"$ESCAPED_ARG\""
done
ARGS_JSON+="]"

# Extract plugin directories
PLUGIN_DIRS="["
FIRST=true
PREV_ARG=""
for arg in "$@"; do
  if [ "$PREV_ARG" = "--plugin-dir" ]; then
    if [ "$FIRST" = true ]; then
      FIRST=false
    else
      PLUGIN_DIRS+=","
    fi
    ESCAPED_DIR=$(printf '%s' "$arg" | sed 's/\\/\\\\/g; s/"/\\"/g')
    PLUGIN_DIRS+="\"$ESCAPED_DIR\""

    # Validate plugin directory if enabled
    if [ "$VALIDATE_PLUGINS" = "1" ]; then
      if [ ! -d "$arg" ]; then
        echo "Claude shim error: Plugin directory does not exist: $arg" >&2
        exit 1
      fi
      if [ ! -f "$arg/.claude-plugin/plugin.json" ]; then
        echo "Claude shim error: Missing plugin.json in: $arg" >&2
        exit 1
      fi
    fi
  fi
  PREV_ARG="$arg"
done
PLUGIN_DIRS+="]"

# Check for mcp-config
MCP_CONFIG=""
PREV_ARG=""
for arg in "$@"; do
  if [ "$PREV_ARG" = "--mcp-config" ]; then
    MCP_CONFIG="$arg"
    break
  fi
  PREV_ARG="$arg"
done

# Write output
cat > "$OUTPUT_FILE" << EOJSON
{
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "args": $ARGS_JSON,
  "pluginDirs": $PLUGIN_DIRS,
  "mcpConfig": $([ -n "$MCP_CONFIG" ] && echo "\"$MCP_CONFIG\"" || echo "null"),
  "workingDir": "$(pwd)"
}
EOJSON

# Print to stderr for debugging (visible in test output)
echo "Claude shim invoked with args: $@" >&2
echo "Output written to: $OUTPUT_FILE" >&2

exit "$EXIT_CODE"
